name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ['3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync
          uv add --dev pyinstaller

      - name: Build application with PyInstaller
        run: uv run python build_exe.py

      - name: Get artifact name
        id: artifact-name
        shell: bash
        run: |
          # release/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®zipãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
          cd release
          ZIP_FILE=$(ls BookmarkAnalyticsToolkit_Windows_*.zip | head -n 1)
          echo "name=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "path=release/$ZIP_FILE" >> $GITHUB_OUTPUT

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ steps.artifact-name.outputs.path }}'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BookmarkAnalyticsToolkit-Windows
          path: ${{ steps.artifact-name.outputs.path }}
          retention-days: 90

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: artifacts/**/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Bookmark Analytics Toolkit - Windowsç‰ˆ

            ### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¾ã™:
            - Windows 10/11 (64bit): `BookmarkAnalyticsToolkit_Windows_v*.zip`

            ### ğŸš€ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            1. **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: ä¸Šè¨˜ã®zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
            2. **è§£å‡**: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸzipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«è§£å‡ã—ã¦ãã ã•ã„
            3. **èµ·å‹•**: `BookmarkAnalyticsToolkit.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•
            4. **ãƒ–ãƒ©ã‚¦ã‚¶**: è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

            ### ğŸ“ ä½¿ç”¨æ–¹æ³•
            1. ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‹ã‚‰ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSV/JSONï¼‰ã‚’é¸æŠ
            2. å„ã‚¿ãƒ–ã§æ§˜ã€…ãªåˆ†æçµæœã‚’ç¢ºèªã§ãã¾ã™
            3. çµ‚äº†ã™ã‚‹å ´åˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦ãã ã•ã„

            ### ğŸ“Š ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            1. NirSoftã®ã€ŒWebBrowserBookmarksã€ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
               https://www.nirsoft.net/utils/web_browser_bookmarks_view.html
            2. WebBrowserBookmarksã‚’èµ·å‹•ï¼ˆPCã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒè‡ªå‹•èª­è¾¼ã•ã‚Œã‚‹ï¼‰
            3. Ctrl+Aã§å…¨é¸æŠ â†’ ä¿å­˜ãƒœã‚¿ãƒ³ã§CSV/JSONå½¢å¼ã§ä¿å­˜
            4. ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ã‚¢ãƒ—ãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

            ### âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …
            - **åˆå›èµ·å‹•**: åˆå›èµ·å‹•æ™‚ã¯10ã€œ30ç§’ç¨‹åº¦ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
            - **Windows Defender**: è­¦å‘ŠãŒå‡ºã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆPyInstallerã®ä¸€èˆ¬çš„ãªç¾è±¡ï¼‰
              - ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã§èµ·å‹•ã§ãã¾ã™
              - å®‰å…¨æ€§ãŒå¿ƒé…ãªå ´åˆã¯ã€GitHubã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã¾ã™
            - **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ç´„800MBï¼ˆSudachiPyè¾æ›¸ãƒ‡ãƒ¼ã‚¿ç´„300MBå«ã‚€ï¼‰
            - **ãƒãƒ¼ãƒˆä½¿ç”¨**: localhost:8501ã‚’ä½¿ç”¨ã—ã¾ã™

            ### âœ… å‹•ä½œç’°å¢ƒ
            - Windows 10 / 11 (64bit)
            - ãƒ¡ãƒ¢ãƒª: 4GBä»¥ä¸Šæ¨å¥¨
            - ãƒ‡ã‚£ã‚¹ã‚¯ç©ºãå®¹é‡: 1GBä»¥ä¸Š

            ### ğŸ” Verification
            ã™ã¹ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¯ GitHub Artifact Attestations ã§ç½²åã•ã‚Œã¦ã„ã¾ã™ã€‚
            ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§çœŸæ­£æ€§ã‚’æ¤œè¨¼ã§ãã¾ã™:
            ```bash
            gh attestation verify <file> --owner ${{ github.repository_owner }}
            ```

            ### ğŸ“‹ å¤‰æ›´ç‚¹
            ä»¥ä¸‹ã®è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
